name: Terraform Deployment
on:
  push:
    branches:
      - main

permissions:
    id-token: write
    contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    steps:
        - name: 'Az CLI login using OIDC'
          uses: azure/login@v1
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  
        - name: Checkout Repository
          uses: actions/checkout@v2
  
        - name: Set up Terraform
          uses: hashicorp/setup-terraform@v1
          with:
            terraform_wrapper: false

        - name: TFInit
          run: terraform init
          working-directory: ./db
          

        # - name: TFPlan
        #   run: terraform plan
        #   working-directory: ./db

        - name: TFApply
          id: tfapply
          working-directory: ./db
          run: | 
            terraform apply -auto-approve
            echo "COSMOSDB_CONNECTION_STRING=$(terraform output -json cosmosdb_connection_string)" >> "$GITHUB_ENV"

        # - name: Set Cosmos DB Connection String as Env Var
        #   run: |
        #     echo "COSMOSDB_CONNECTION_STRING=$(terraform output -raw cosmosdb_connection_string)" >> "$GITHUB_ENV"

          #terraform the other 2 dirs

        - name: Set up Python
          uses: actions/setup-python@v2
          with:
            python-version: 3.11


        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install azure-cosmos
          working-directory: ./db

        - name: Run seeding script
          run: |
            python ./seed.py \
            --cosmosdb-connection-string '$(terraform output cosmosdb_connection_string)' \
            --database-name "${COSMOSDB_DATABASE_NAME}" \
            --container-name "${COSMOSDB_CONTAINER_NAME}"
          working-directory: ./db
          env:
            PYTHONPATH: "./"